
# 🎬 电影剪辑系统 - 详细使用教程

## 📋 目录
- [系统简介](#系统简介)
- [环境准备](#环境准备)
- [目录结构](#目录结构)
- [AI配置教程](#ai配置教程)
- [使用流程](#使用流程)
- [常见问题](#常见问题)

## 🎯 系统简介

本系统是一个智能电影剪辑工具，通过AI分析字幕文件，自动识别精彩片段并进行视频剪辑。

### 核心功能
- 🤖 AI智能分析电影字幕
- 🎬 自动识别精彩片段
- ✂️ 批量视频剪辑
- 💾 智能缓存机制
- 📊 处理状态管理

### 技术特点
- 明确区分官方API（无URL）和中转API（需要URL）
- 使用SRT文件名作为电影标识，按字符串排序处理
- 支持多种AI服务（Gemini官方、OpenAI兼容中转API）
- 自动缓存AI分析结果，避免重复调用

## 🔧 环境准备

### 1. 系统要求
- Python 3.8+
- FFmpeg（用于视频处理）
- 网络连接（调用AI API）

### 2. 安装依赖
系统会自动安装以下依赖包：
```bash
pip install requests google-generativeai openai
```

### 3. FFmpeg安装
- **Linux/Replit**: 通常已预装
- **Windows**: 下载并添加到PATH
- **macOS**: `brew install ffmpeg`

## 📁 目录结构

```
project/
├── clean_main.py           # 主程序
├── .ai_config.json         # AI配置文件（自动生成）
├── movie_srt/              # 字幕文件目录
│   ├── 电影1.srt
│   ├── 电影2.srt
│   └── 电影3.txt
├── movie_videos/           # 视频文件目录
│   ├── 电影1.mp4
│   ├── 电影2.mkv
│   └── 电影3.avi
├── movie_clips/            # 输出片段目录（自动生成）
│   ├── 电影1_精彩片段1_seg1.mp4
│   └── 电影1_精彩片段2_seg2.mp4
└── ai_cache/               # AI分析缓存（自动生成）
    └── analysis_电影1_abc123.json
```

### 目录说明
- `movie_srt/`: 放置字幕文件（.srt 或 .txt）
- `movie_videos/`: 放置对应的视频文件
- `movie_clips/`: 系统自动生成的剪辑片段
- `ai_cache/`: AI分析结果缓存

## 🤖 AI配置教程

### 1. 官方API配置（推荐Gemini）

#### Gemini官方API
```json
{
    "enabled": true,
    "api_type": "official",
    "provider": "gemini",
    "api_key": "your-gemini-api-key",
    "model": "gemini-2.5-flash"
}
```

**获取步骤：**
1. 访问 [Google AI Studio](https://aistudio.google.com/apikey)
2. 登录Google账号
3. 创建API密钥
4. 复制密钥到配置中

**优势：**
- 官方稳定
- 响应速度快
- 支持中文
- 价格相对便宜

### 2. 中转API配置

#### ChatAI API（推荐）
```json
{
    "enabled": true,
    "api_type": "proxy",
    "provider": "ChatAI API",
    "base_url": "https://www.chataiapi.com/v1",
    "api_key": "your-chatai-key",
    "model": "deepseek-r1"
}
```

**获取步骤：**
1. 访问 [ChatAI API](https://www.chataiapi.com/)
2. 注册账号并充值
3. 获取API密钥
4. 选择合适的模型

#### OpenRouter
```json
{
    "enabled": true,
    "api_type": "proxy",
    "provider": "OpenRouter",
    "base_url": "https://openrouter.ai/api/v1",
    "api_key": "your-openrouter-key",
    "model": "anthropic/claude-3.5-sonnet"
}
```

### 3. 配置文件说明

**关键字段：**
- `api_type`: 
  - `"official"`: 官方API，无需base_url
  - `"proxy"`: 中转API，需要base_url
- `provider`: API提供商名称
- `base_url`: 仅中转API需要
- `api_key`: API密钥
- `model`: 模型名称

## 🚀 使用流程

### 1. 启动系统
```bash
python clean_main.py
```

### 2. 首次使用 - 配置AI

运行后会看到主菜单：
```
🎬 电影剪辑系统
==================================================
🤖 AI状态: ❌ 未配置
📝 字幕文件: 0 个
🎬 视频文件: 0 个

🎯 功能菜单:
1. 🤖 配置AI接口
2. 🚀 一键智能剪辑
3. 📊 查看状态
0. ❌ 退出

请选择 (0-3):
```

**选择 "1" 配置AI：**

1. 选择API类型：
   ```
   选择API类型:
   1. 🔒 官方API (Gemini官方)
   2. 🌐 中转API (OpenAI兼容)
   0. ❌ 跳过配置
   ```

2. 如选择官方API：
   ```
   🔒 Gemini官方API配置
   获取API密钥: https://aistudio.google.com/apikey
   
   Gemini API密钥: [输入密钥]
   
   选择模型:
   1. gemini-2.5-flash
   2. gemini-2.5-pro
   3. gemini-1.5-flash
   ```

3. 如选择中转API：
   ```
   选择中转服务:
   1. ChatAI API
   2. OpenRouter
   3. 自定义中转
   ```

4. 系统会自动测试连接，成功后保存配置

### 3. 准备文件

#### 准备字幕文件
将字幕文件放入 `movie_srt/` 目录：
```
movie_srt/
├── 01_开场.srt
├── 02_冲突.srt
├── 03_高潮.srt
└── 04_结局.srt
```

**命名规则：**
- 使用有意义的文件名，系统会直接使用文件名作为电影标识
- 按字符串排序就是处理顺序
- 支持 `.srt` 和 `.txt` 格式

#### 准备视频文件
将对应视频文件放入 `movie_videos/` 目录：
```
movie_videos/
├── 01_开场.mp4
├── 02_冲突.mkv
├── 03_高潮.avi
└── 04_结局.mov
```

**匹配规则：**
- 系统会自动匹配同名视频文件
- 支持 `.mp4`, `.mkv`, `.avi`, `.mov` 格式
- 如果没有同名文件，会进行模糊匹配

### 4. 执行剪辑

在主菜单选择 "2. 🚀 一键智能剪辑"：

```
🚀 批量处理所有电影
========================================
📝 找到 4 个字幕文件

🎬🎬🎬 第 1/4 部 🎬🎬🎬
====================
文件: 01_开场.srt
📖 解析字幕: 01_开场.srt
✅ 解析完成: 245 条字幕
🤖 AI分析中: 01_开场
✅ AI分析完成
📁 视频: 01_开场.mp4

🎬 剪辑片段 1: 精彩对白
    ✅ 成功: 15.3MB
🎬 剪辑片段 2: 动作场面
    ✅ 成功: 22.1MB
✅ 完成！生成 2 个片段
```

### 5. 查看结果

剪辑完成后，在 `movie_clips/` 目录查看生成的片段：
```
movie_clips/
├── 01_开场_精彩对白_seg1.mp4
├── 01_开场_动作场面_seg2.mp4
├── 02_冲突_情感爆发_seg1.mp4
└── 02_冲突_紧张对峙_seg2.mp4
```

## 📊 系统特性

### 1. 智能缓存机制
- AI分析结果会自动缓存到 `ai_cache/` 目录
- 相同内容不会重复分析，节省API调用
- 缓存文件名包含内容哈希，确保准确性

### 2. 文件名处理
- 直接使用SRT文件名作为电影标识
- 支持中文文件名
- 自动生成安全的输出文件名

### 3. 批量处理
- 按字符串排序处理所有SRT文件
- 自动匹配对应的视频文件
- 支持中断后继续处理

### 4. 错误处理
- 网络异常自动重试
- 文件编码自动检测
- 详细的错误信息显示

## ❓ 常见问题

### Q1: AI配置失败怎么办？
**A1:** 检查以下项目：
- API密钥是否正确
- 网络连接是否正常
- 账户余额是否充足
- 模型名称是否正确

### Q2: 找不到视频文件？
**A2:** 确保：
- 视频文件在 `movie_videos/` 目录
- 文件名与字幕文件基本匹配
- 文件格式被支持（mp4/mkv/avi/mov）

### Q3: 剪辑失败？
**A3:** 可能原因：
- FFmpeg未安装或不可用
- 视频文件损坏
- 时间标记格式错误
- 磁盘空间不足

### Q4: AI分析结果不理想？
**A4:** 优化建议：
- 尝试不同的AI模型
- 检查字幕内容质量
- 调整分析提示词
- 使用更强大的模型（如GPT-4）

### Q5: 如何重新分析某部电影？
**A5:** 删除对应的缓存文件：
```bash
rm ai_cache/analysis_电影名_*.json
```

### Q6: 支持哪些字幕格式？
**A6:** 
- 标准SRT格式
- 纯文本格式（.txt）
- 支持UTF-8、GBK等编码

### Q7: 如何自定义输出格式？
**A7:** 修改 `_create_single_clip` 方法中的FFmpeg参数：
```python
cmd = [
    'ffmpeg', '-i', video_file,
    '-ss', str(start_seconds),
    '-t', str(duration),
    '-c:v', 'libx264',    # 视频编码
    '-c:a', 'aac',        # 音频编码
    '-preset', 'medium',   # 编码速度
    '-crf', '23',         # 质量参数
    output_path, '-y'
]
```

## 🎯 使用技巧

### 1. 提高处理效率
- 使用SSD存储，提高IO速度
- 选择合适的AI模型（速度vs质量）
- 合理命名文件，便于管理

### 2. 优化剪辑质量
- 确保字幕文件准确完整
- 选择高质量的源视频
- 根据需要调整FFmpeg参数

### 3. 批量处理建议
- 先处理几个样本验证效果
- 确保有足够的存储空间
- 定期备份重要文件

## 📞 技术支持

如遇到问题，请检查：

1. **系统状态**: 菜单中选择 "3. 📊 查看状态"
2. **日志信息**: 查看控制台输出
3. **配置文件**: 检查 `.ai_config.json` 内容
4. **目录权限**: 确保有读写权限

---

🎬 **祝您使用愉快！** 如有问题欢迎反馈。
