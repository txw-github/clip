
# 智能电视剧剪辑系统 - 完整使用教程

## 📖 系统概述

这是一个智能的电视剧剪辑系统，能够自动分析字幕文件，识别精彩剧情片段，并生成短视频片段。系统支持AI分析和基础规则分析两种模式。

### 🎯 主要功能

- **智能剧情点识别**: 自动识别关键冲突、人物转折、线索揭露、情感爆发、重要对话等剧情点
- **AI分析可选**: 支持官方API和中转API，无AI也能正常工作
- **完整句子保证**: 确保视频片段在完整句子处开始和结束
- **第三人称旁白**: 自动生成适合短视频的第三人称旁白字幕
- **错别字修正**: 自动修正常见错别字（如：防衛→防卫，正當→正当）
- **分析结果缓存**: 避免重复分析，提高效率
- **按文件名排序**: SRT文件名的字符串排序即为电视剧播放顺序

## 🚀 快速开始

### 1. 准备文件

首先，你需要准备以下文件：

```
项目目录/
├── srt/              # 字幕文件目录
│   ├── E01.srt       # 第1集字幕
│   ├── E02.srt       # 第2集字幕
│   └── E03.srt       # 第3集字幕
├── videos/           # 视频文件目录
│   ├── E01.mp4       # 第1集视频
│   ├── E02.mp4       # 第2集视频
│   └── E03.mp4       # 第3集视频
└── clips/            # 输出目录（自动创建）
```

**重要说明**：
- 字幕文件支持 `.srt` 和 `.txt` 格式
- 视频文件支持 `.mp4`、`.mkv`、`.avi`、`.mov`、`.wmv`、`.flv` 格式
- 文件名要能够匹配（如 `E01.srt` 对应 `E01.mp4`）
- SRT文件名的字符串排序就是电视剧的播放顺序

### 2. 启动系统

运行主程序：

```bash
python clean_main.py
```

系统会显示主菜单：

```
🎬 智能电视剧剪辑系统
============================================================
AI状态: 📝 基础规则分析
文件状态: 📝3个字幕 🎬3个视频 📤0个片段

🎯 主要功能:
1. 🤖 配置AI接口
2. 🎬 开始智能剪辑
3. 📁 查看文件状态
0. ❌ 退出系统
```

## 🤖 AI配置（可选但推荐）

### 选择1：官方API配置

如果你有Google Gemini等官方API：

1. 选择菜单项 `1. 🤖 配置AI接口`
2. 选择 `1. 🔒 官方API`
3. 输入API密钥
4. 选择模型（默认：gemini-2.5-flash）
5. 系统会自动测试连接

**官方API示例配置**：
```json
{
  "enabled": true,
  "api_type": "official",
  "provider": "gemini",
  "api_key": "你的API密钥",
  "model": "gemini-2.5-flash"
}
```

### 选择2：中转API配置（推荐）

如果你使用ChatAI、OpenRouter等中转服务：

1. 选择菜单项 `1. 🤖 配置AI接口`
2. 选择 `2. 🌐 中转API`
3. 输入API地址（如：https://www.chataiapi.com/v1）
4. 输入API密钥
5. 输入模型名称（如：deepseek-r1）
6. 系统会自动测试连接

**中转API示例配置**：
```json
{
  "enabled": true,
  "api_type": "proxy",
  "provider": "proxy",
  "base_url": "https://www.chataiapi.com/v1",
  "api_key": "你的API密钥",
  "model": "deepseek-r1"
}
```

### 推荐的AI模型

**中转API推荐模型**：
- `deepseek-r1` - 思考链模型，分析能力强
- `claude-3-5-sonnet` - Claude模型，文本理解好
- `gpt-4o` - GPT-4模型，综合能力强
- `gemini-2.5-pro` - Gemini Pro，多模态能力

**官方API推荐模型**：
- `gemini-2.5-flash` - 速度快，成本低
- `gemini-2.5-pro` - 能力强，适合复杂分析

## 🎬 开始剪辑

### 基本流程

1. 确保字幕和视频文件已准备好
2. 选择菜单项 `2. 🎬 开始智能剪辑`
3. 系统会按SRT文件名顺序处理每一集
4. 等待处理完成

### 处理过程详解

**第一步：字幕解析**
```
📺 处理第 1/3 集: E01.srt
============================================================
📖 解析字幕: E01.srt
✅ 解析完成: 1247 条字幕
```

**第二步：剧情分析**
```
🤖 AI分析成功: 4 个片段
🎯 识别到 4 个剧情点:
    1. 关键冲突 (时长: 180.5秒, 评分: 8.5)
    2. 线索揭露 (时长: 165.2秒, 评分: 7.8)
    3. 人物转折 (时长: 155.8秒, 评分: 7.2)
    4. 情感爆发 (时长: 142.3秒, 评分: 6.9)
```

**第三步：视频剪辑**
```
📁 视频文件: E01.mp4
🎬 剪辑片段: E01_关键冲突_1.mp4
   时间: 00:15:23,150 --> 00:18:23,650
   类型: 关键冲突
   ✅ 成功: 15.2MB
   📝 说明文件: E01_关键冲突_1_片段说明.txt
```

### 系统自动优化

**完整句子保证**：
- 系统会自动寻找完整句子的开始和结束点
- 避免在对话中间截断
- 确保"一句话讲完"的原则

**时长优化**：
- 关键冲突：目标180秒
- 人物转折：目标150秒  
- 线索揭露：目标160秒
- 情感爆发：目标140秒
- 重要对话：目标170秒

## 📂 输出文件详解

### 视频片段文件

每个剧情点会生成一个视频文件，命名格式：
```
E01_关键冲突_1.mp4
E01_线索揭露_2.mp4
E01_人物转折_3.mp4
```

### 片段说明文件

每个视频片段都有对应的说明文件：
```
📺 电视剧短视频片段说明文档
============================================================

【基本信息】
集数编号：第01集
片段类型：关键冲突
片段标题：E01-关键冲突：剧情核心时刻

【时间信息】
开始时间：00:15:23,150
结束时间：00:18:23,650
片段时长：180.5 秒

【剧情分析】
剧情意义：关键冲突重要剧情发展节点
内容摘要：核心剧情发展，法庭上双方展开激烈辩论...

【内容亮点】
• 精彩剧情发展
• 角色深度刻画

【第三人称旁白字幕】
此时双方展开激烈辩论，各自坚持己见，争议焦点逐渐明朗。
关键证据的效力成为争议核心，每一个细节都可能影响最终判决。

【技术说明】
• 片段保证在完整句子处开始和结束
• 自动修正了常见错别字
• 第三人称旁白可直接用于视频制作
```

### 分析报告

系统会生成完整的处理报告：
```
reports/智能剪辑报告.txt
```

## 🔧 高级功能

### 缓存机制

**分析结果缓存**：
- 每次分析结果会自动缓存
- 重复运行时会使用缓存，避免重复分析
- 缓存文件位于 `analysis_cache/` 目录

**断点续传**：
- 如果视频片段已存在，会自动跳过
- 支持中断后继续处理

### 错别字修正

系统内置常见错别字修正：
```python
'防衛' → '防卫'
'正當' → '正当'  
'証據' → '证据'
'檢察官' → '检察官'
'審判' → '审判'
'辯護' → '辩护'
# ... 更多修正规则
```

### 剧情点识别规则

**关键冲突**：
- 关键词：冲突、争执、对抗、质疑、反驳、争议等
- 权重：10（最高优先级）
- 理想时长：180秒

**人物转折**：
- 关键词：决定、改变、选择、转变、觉悟、明白等
- 权重：9
- 理想时长：150秒

**线索揭露**：
- 关键词：发现、揭露、真相、证据、线索、秘密等
- 权重：8
- 理想时长：160秒

**情感爆发**：
- 关键词：哭、痛苦、绝望、愤怒、激动、崩溃等
- 权重：7
- 理想时长：140秒

**重要对话**：
- 关键词：告诉、承认、坦白、解释、澄清、说明等
- 权重：6
- 理想时长：170秒

## 🔍 故障排除

### 常见问题

**1. 找不到视频文件**
```
❌ 未找到视频文件
```
**解决方案**：
- 检查视频文件是否在 `videos/` 目录
- 确认文件名匹配（如 `E01.srt` 对应 `E01.mp4`）
- 支持的视频格式：.mp4, .mkv, .avi, .mov, .wmv, .flv

**2. FFmpeg未找到**
```
❌ 未找到FFmpeg，无法剪辑视频
```
**解决方案**：
- 安装FFmpeg：`sudo apt-get install ffmpeg`（Linux）
- 或下载FFmpeg并添加到系统PATH

**3. AI连接失败**
```
❌ 连接测试失败
```
**解决方案**：
- 检查网络连接
- 验证API密钥是否正确
- 确认API地址格式正确
- 检查API额度是否充足

**4. 字幕解析失败**
```
❌ 字幕解析失败
```
**解决方案**：
- 检查SRT文件格式是否正确
- 尝试转换文件编码为UTF-8
- 确认时间格式：`00:00:23,150 --> 00:00:26,950`

### 测试AI连接

如果配置了AI，可以使用菜单项 `4. 🔍 测试AI连接` 来检测：

```
🔍 AI连接测试
========================================
📋 当前配置信息:
   类型: proxy
   服务商: proxy
   模型: deepseek-r1
   地址: https://www.chataiapi.com/v1
   密钥: sk-CU2KOp...

✅ 连接测试成功！
```

## 📊 性能优化

### 处理大量集数

**建议**：
- 单次处理不超过20集
- 确保磁盘空间充足（每集约生成200-500MB视频）
- 使用SSD可以提高处理速度

### AI分析优化

**模型选择**：
- 对于复杂剧情：推荐 `claude-3-5-sonnet` 或 `gpt-4o`
- 对于成本考虑：推荐 `deepseek-r1` 或 `gemini-2.5-flash`
- 对于速度要求：推荐 `gemini-2.5-flash`

**无AI模式**：
- 基础规则分析也能产生良好效果
- 处理速度更快，无API成本
- 适合批量处理和测试

## 🎯 最佳实践

### 文件命名建议

**推荐的SRT文件命名**：
```
E01.srt, E02.srt, E03.srt, ...
第01集.srt, 第02集.srt, 第03集.srt, ...
S01E01.srt, S01E02.srt, S01E03.srt, ...
```

**对应的视频文件命名**：
```
E01.mp4, E02.mp4, E03.mp4, ...
第01集.mp4, 第02集.mp4, 第03集.mp4, ...
S01E01.mp4, S01E02.mp4, S01E03.mp4, ...
```

### 质量控制

**检查输出片段**：
1. 确认时长合理（2-3分钟）
2. 检查开始和结束是否在完整句子处
3. 验证第三人称旁白是否恰当
4. 确认剧情点分类是否准确

**优化建议**：
1. 高质量的字幕文件能产生更好的结果
2. 清晰的视频文件便于后期处理
3. 合理使用AI分析能显著提升效果
4. 定期清理缓存文件释放空间

## 📝 使用小贴士

1. **首次使用**：先用一两集测试效果，再批量处理
2. **AI模型**：不同模型适合不同类型的剧集
3. **文件整理**：保持目录结构清晰，便于管理
4. **备份重要**：处理前建议备份原始文件
5. **性能监控**：注意磁盘空间和内存使用情况

## 🆘 技术支持

如果遇到问题：

1. 检查系统依赖：Python 3.7+, FFmpeg
2. 查看错误日志和提示信息
3. 验证文件格式和目录结构
4. 测试AI连接状态
5. 查阅本教程的故障排除部分

---

**祝你使用愉快！**🎬✨
